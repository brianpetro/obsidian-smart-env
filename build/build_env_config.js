#!/usr/bin/env node
/**
 * obsidian-smart-env/build/build_env_config.js
 *
 * Scans ./src for collections, items, components, and actions (supports sub-folders),
 * generates "./smart_env.config.js" with static import statements.
 *
 * Actions are now flattened like components:
 *   - nested folder/file paths become snake_case keys joined with underscores
 *     e.g. actions/parent/child.js -> actions.parent_child in config
 *   - dots in names are sanitized to underscores: parent.child -> parent_child
 *   - the action's named export may match either the file name ("child") or the
 *     flattened path key ("parent_child").
 *
 * Run: `node obsidian-smart-env/build/build_env_config.js`
 */

import fs from 'fs';
import path from 'path';
import {
  CollectionsLoader,
  ItemsLoader,
  ModulesLoader,
  ComponentsLoader,
  ActionsLoader
} from 'smart-environment/loaders/index.js';

export function build_smart_env_config(dist_dir, roots) {
  if (!fs.existsSync(dist_dir)) {
    fs.mkdirSync(dist_dir, { recursive: true });
  }

  const collections_loader = new CollectionsLoader({ dist_dir });
  const items_loader = new ItemsLoader({ dist_dir });
  const modules_loader = new ModulesLoader({ dist_dir });
  const components_loader = new ComponentsLoader({ dist_dir });
  const actions_loader = new ActionsLoader({ dist_dir });

  roots.forEach(root => {
    collections_loader.scan_root(root);
    items_loader.scan_root(root);
    modules_loader.scan_root(root);
    components_loader.scan_root(root);
    actions_loader.scan_root(root);
  });

  const collection_imports = collections_loader.build_imports();
  const item_imports = items_loader.build_imports();
  const module_imports = modules_loader.build_imports();
  const component_imports = components_loader.build_imports();
  const action_imports = actions_loader.build_imports();

  const collections_config = collections_loader.build_config();
  const item_types_config = items_loader.build_item_types_config();
  const items_config = items_loader.build_items_config();
  const modules_config = modules_loader.build_config();
  const components_config = components_loader.build_config();
  const actions_config = actions_loader.build_config();

  const final_code = [
    '// AUTO-GENERATED by obsidian-smart-env/build/build_env_config.js. DO NOT EDIT.',
    collection_imports,
    item_imports,
    module_imports,
    component_imports,
    action_imports,
    `
export const smart_env_config = {
  collections: {
${collections_config}
  },
  item_types: {
${item_types_config}
  },
  items: {
${items_config}
  },
  modules: {
${modules_config}
  },
  components: {
${components_config}
  },
  actions: {
${actions_config}
  }
};
`
  ].join('\n');

  const out_file = path.join(dist_dir, 'smart_env.config.js');
  fs.writeFileSync(out_file, final_code, 'utf-8');
  console.log(`Wrote ${out_file}`);
}
